<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Running k8s cluster at home</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
<link href="font-awesome/css/fontawesome.css" rel="stylesheet">
<link href="font-awesome/css/brands.css" rel="stylesheet">
<link href="font-awesome/css/solid.css" rel="stylesheet">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="intro.html">Intro</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="network/index.html"><strong aria-hidden="true">1.</strong> Network</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">1.1.</strong> Topology</div></li><li class="chapter-item expanded "><a href="network/vlan.html"><strong aria-hidden="true">1.2.</strong> VLAN</a></li><li class="chapter-item expanded "><a href="network/firewall.html"><strong aria-hidden="true">1.3.</strong> Firewall</a></li></ol></li><li class="chapter-item expanded "><a href="server/index.html"><strong aria-hidden="true">2.</strong> Server</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">2.1.</strong> Initial setup</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">2.1.1.</strong> MicroK8S</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.2.</strong> Configuration</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="configuration/zfs.html"><strong aria-hidden="true">2.2.1.</strong> ZFS</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.2.2.</strong> OpenEBS</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.2.3.</strong> DNS</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.3.</strong> Network policies</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> External services</div></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="about-me.html">About me</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Running k8s cluster at home</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="intro"><a class="header" href="#intro"><i class="fa-solid fa-meteor"></i> Intro</a></h1>
<p>Hello reader.</p>
<p>Have you ever wondered how to run a Kubernetes cluster on your own home network? If the answer is yes, look no further.
If on the other hand, you have not considered running your own K8S cluster, after reading all the good reasons, you will hopefully order an Intel NUC to try it out yourself.</p>
<p>I have decided to document all of the steps I took to have my own K8S cluster, in a form of a markdown book.
If I ever need to redo it, I can go back and hopefully save some time while figuring out how things should be set up.</p>
<p>You may also wonder, why would anyone want to run their own Kubernetes cluster. Well, there are a few reasons:</p>
<ul>
<li>It's much easier to run your applications that way (as opposed to <a href="https://www.vagrantup.com/">Vagrant</a> or <a href="https://www.proxmox.com/en/">Proxmox</a>). Nowadays the whole internet runs on Docker and you can find any container you need.</li>
<li>Less manual steps (once the cluster is up and running). There are tools for provisioning Kubernetes that are as easy to use as Docker itself. <a href="https://helm.sh/">Helm</a> is one of them.</li>
<li>It's a lot of fun!</li>
</ul>
<blockquote>
<p>ℹ️  <strong>Note</strong></p>
<p><strong>Keep in mind</strong>, I'm no expert in that field and this is my attempt to get more familiar with networking and Kubernetes.
<code>If you find anything I do completely wrong</code> &lt;- <code>TODO: fix this sentence, please let me know</code>.</p>
</blockquote>
<p>I would also like to mention, this whole book is about my personal set up, so some things might not be relevant to you.
In each chapter, I will try to include all the details about any hardware or software I use which is relevant to that chapter.</p>
<h2 id="goals"><a class="header" href="#goals">Goals</a></h2>
<p>There are few things I want to achieve.</p>
<ul>
<li>Have a separate network (Homecloud) for running Kubernetes and other internal applications like Home Assistant.</li>
<li>Only selected devices on the main LAN should be able to access Homecloud.</li>
<li>Have an internal DNS server for local applications.</li>
<li>Expose some applications on my routers public IP.</li>
</ul>
<p>I will touch on each of the points in further chapters, and try to make a point of why I want it that way. I will also explain how you can buid it id another way.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="network"><a class="header" href="#network"><i class="fa-solid fa-network-wired"></i> Network</a></h1>
<p>Let's start with the network, because it's the foundation for ther rest of what we are going to do.</p>
<blockquote>
<p>ℹ️ <strong>Note</strong></p>
<p>You can skip this whole chapter if you just want to play with Kubernetes. It is ok to run your cluster on the same network as other devices.</p>
</blockquote>
<h2 id="prerequirements"><a class="header" href="#prerequirements">Prerequirements</a></h2>
<ul>
<li>You should have admin access to your router.</li>
<li>Extra points if you run any of the open source OS on your router. That is not a requirement as long as you can configure <code>VLAN</code> network on your router.</li>
</ul>
<h2 id="router"><a class="header" href="#router">Router</a></h2>
<p>I personally use <a href="https://opnsense.org/"><strong>OPNsense</strong></a>, so all the configuration will be provided for <code>OPNsense</code>. If you use something else, you will need to figure out how to configura your router yourself<sup class="footnote-reference"><a href="#routerOS">1</a></sup>.</p>
<p>If you can't configure <code>VLAN</code> on your router, you should check if it can be flashed and is capable of running <code>OPNsense</code>, or <a href="https://openwrt.org/">OpenWrt</a> which is less demanding when it comes to the hardware.</p>
<p>You can also buy a new router. There are plenty of articles about routers capable of running <code>OPNsense</code>. If you ask me, I would recommend one of these: <a href="https://teklager.se/en/products/routers/">https://teklager.se/en/products/routers/</a><sup class="footnote-reference"><a href="#teklager">2</a></sup>.</p>
<h2 id="vlan"><a class="header" href="#vlan">VLAN</a></h2>
<p>You may be wondering what the hell is <code>VLAN</code> and why do I need it. Don't worry about it now, everything will be clarified in the <a href="network/vlan.html">VLAN chapter</a>. But first we should take a look at how the network should look like.</p>
<div class="footnote-definition" id="routerOS"><sup class="footnote-definition-label">1</sup>
<p>If you do that, and you want to share how, please let me know so we can update the book.</p>
</div>
<div class="footnote-definition" id="teklager"><sup class="footnote-definition-label">2</sup>
<p>These guys are really passionate about routers, and they build very well made hardware.</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vlan-1"><a class="header" href="#vlan-1">VLAN</a></h1>
<blockquote>
<p>⚠️  <strong>TODO</strong></p>
<ul>
<li>Explain why <code>VLAN</code></li>
<li>Security</li>
</ul>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="firewall"><a class="header" href="#firewall"><i class="fa-solid fa-fire"></i> Firewall</a></h1>
<blockquote>
<p><strong>Warning</strong></p>
<p>Fill this section with useful information. </p>
</blockquote>
<h2 id="notes"><a class="header" href="#notes">Notes</a></h2>
<p>To be able to access forwarded port from local LAN, the Outbound NAT is required.</p>
<p><img src="https://user-images.githubusercontent.com/6637762/198849585-bb027242-f453-4159-b754-a7f7c0b4ab22.png" alt="image" /></p>
<p>https://forum.opnsense.org/index.php?topic=22890.0</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="server"><a class="header" href="#server"><i class="fa-solid fa-server"></i> Server</a></h1>
<p>TODO:</p>
<ul>
<li>What OS am I running, and why is it Ubuntu <i class="fa-brands fa-ubuntu"></i> <i class="fa-solid fa-heart"></i>.</li>
</ul>
<blockquote>
<p>ℹ️ <strong>Note</strong></p>
<p>If you don't have spare NUC (or any device capable of running MicroK8s) laying around, you can create a VM and play with things there.
I really recommend using <a href="https://www.vagrantup.com/">Vagrant</a> for that.</p>
<p>As mentioned above, all the commands will be run on <code>Ubuntu</code>, so you should get <code>Vagrant</code> image with that OS. You can find it here: <a href="https://app.vagrantup.com/ubuntu/boxes/kinetic64">https://app.vagrantup.com/ubuntu/boxes/kinetic64</a></p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="zfs"><a class="header" href="#zfs"><i class="fa-regular fa-hard-drive"></i> ZFS</a></h1>
<blockquote>
<p>⚠️  <strong>TODO</strong></p>
<p>Add something about how to configure LVM</p>
<p><a href="https://linuxhandbook.com/lvm-guide/">https://linuxhandbook.com/lvm-guide/</a></p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="about-me"><a class="header" href="#about-me"><i class="fa-solid fa-user-astronaut"></i> About me</a></h1>
<p>My name is Kamil, bla bla bla, Software, bla. 🦀 Rust <i class="fa-brands fa-rust"></i> bla bla.</p>
<p>:leopard:</p>
<blockquote>
<p>⚠️  <strong>Warning</strong></p>
<p>Warning test, hmm.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn bla();
<span class="boring">}
</span></code></pre></pre>
</blockquote>
<blockquote>
<p>ℹ️  <strong>Note</strong></p>
<p>Note test, hmm.</p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>
